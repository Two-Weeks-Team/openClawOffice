name: CodeQL Alert â†’ Issue

# NOTE: GitHub Actions does not support `code_scanning_alert` as a trigger.
# We use schedule-based polling + workflow_dispatch instead.
on:
  schedule:
    - cron: '0 */6 * * *'  # 6ì‹œê°„ë§ˆë‹¤ ìë™ ì ê²€
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (ë¯¸ë¦¬ë³´ê¸°ë§Œ, ì‹¤ì œ ì´ìŠˆ ìƒì„± ì•ˆ í•¨)'
        type: boolean
        default: false

permissions:
  issues: write
  security-events: read

jobs:
  sync-alerts:
    name: Sync CodeQL Alerts â†’ Issues
    runs-on: ubuntu-latest
    steps:
      - name: Setup base labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh label create "security" --color "e4e669" --description "Security vulnerability" --force --repo "${{ github.repository }}" 2>/dev/null || true
          gh label create "codeql"   --color "0075ca" --description "Detected by CodeQL"     --force --repo "${{ github.repository }}" 2>/dev/null || true

      - name: Sync open alerts to issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DRY_RUN: ${{ inputs.dry_run || 'false' }}
        run: |
          gh api "repos/${{ github.repository }}/code-scanning/alerts?state=open&per_page=100" \
            --paginate | jq -c '.[]' | while IFS= read -r alert; do

            NUMBER=$(echo "$alert"   | jq -r '.number')
            RULE_ID=$(echo "$alert"  | jq -r '.rule.id')
            RULE_DESC=$(echo "$alert"| jq -r '.rule.description')
            SEC_SEV=$(echo "$alert"  | jq -r '.rule.security_severity_level // empty')
            SEV=$(echo "$alert"      | jq -r '.rule.severity')
            SEVERITY="${SEC_SEV:-$SEV}"
            FILE_PATH=$(echo "$alert"| jq -r '.most_recent_instance.location.path')
            LINE=$(echo "$alert"     | jq -r '.most_recent_instance.location.start_line')
            MESSAGE=$(echo "$alert"  | jq -r '.most_recent_instance.message.text')
            HTML_URL=$(echo "$alert" | jq -r '.html_url')

            # ê²½ë³´ë³„ ë¼ë²¨ ìƒì„± (ì¤‘ë³µ ê°ì§€ìš©)
            gh label create "codeql-alert-${NUMBER}" \
              --color "d93f0b" \
              --description "CodeQL alert #${NUMBER}" \
              --force \
              --repo "${{ github.repository }}" 2>/dev/null || true

            # ì¤‘ë³µ ì´ìŠˆ í™•ì¸ (open + closed ëª¨ë‘)
            COUNT=$(gh issue list \
              --repo "${{ github.repository }}" \
              --label "codeql-alert-${NUMBER}" \
              --state all \
              --json number \
              --jq 'length')

            if [ "$COUNT" -gt 0 ]; then
              echo "â­ï¸  Alert #${NUMBER} â€” ì´ìŠˆ ì´ë¯¸ ì¡´ì¬, ê±´ë„ˆëœ€"
              continue
            fi

            case "$SEVERITY" in
              critical) EMOJI="ğŸ”´" ;;
              high)     EMOJI="ğŸŸ " ;;
              medium)   EMOJI="ğŸŸ¡" ;;
              low)      EMOJI="ğŸŸ¢" ;;
              *)        EMOJI="âš ï¸"  ;;
            esac

            TITLE="${EMOJI} [CodeQL #${NUMBER}] ${RULE_DESC}"

            cat > "/tmp/issue_body_${NUMBER}.md" << EOF
          ## ${EMOJI} CodeQL ë³´ì•ˆ ê²½ë³´ \`#${NUMBER}\`

          | í•­ëª© | ë‚´ìš© |
          |------|------|
          | **ê·œì¹™** | \`${RULE_ID}\` |
          | **ì„¤ëª…** | ${RULE_DESC} |
          | **ì‹¬ê°ë„** | ${SEVERITY} |
          | **ìœ„ì¹˜** | \`${FILE_PATH}:${LINE}\` |

          **ë©”ì‹œì§€**:
          > ${MESSAGE}

          ğŸ”— [CodeQL ê²½ë³´ ë³´ê¸°](${HTML_URL})

          ---
          *ì´ ì´ìŠˆëŠ” CodeQL ë³´ì•ˆ ë¶„ì„ì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*
          EOF

            if [ "$DRY_RUN" = "true" ]; then
              echo "ğŸ” [DRY RUN] ìƒì„± ì˜ˆì •: ${TITLE}"
            else
              ISSUE_URL=$(gh issue create \
                --repo "${{ github.repository }}" \
                --title "${TITLE}" \
                --body-file "/tmp/issue_body_${NUMBER}.md" \
                --label "security,codeql,codeql-alert-${NUMBER}")
              echo "âœ… Alert #${NUMBER} â†’ ${ISSUE_URL}"
            fi
          done

      - name: Close issues for dismissed alerts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DRY_RUN: ${{ inputs.dry_run || 'false' }}
        run: |
          gh api "repos/${{ github.repository }}/code-scanning/alerts?state=dismissed&per_page=100" \
            --paginate | jq -c '.[]' | while IFS= read -r alert; do

            NUMBER=$(echo "$alert" | jq -r '.number')

            OPEN_ISSUES=$(gh issue list \
              --repo "${{ github.repository }}" \
              --label "codeql-alert-${NUMBER}" \
              --state open \
              --json number \
              --jq '.[].number')

            if [ -z "$OPEN_ISSUES" ]; then
              continue
            fi

            while IFS= read -r ISSUE_NUM; do
              [ -z "$ISSUE_NUM" ] && continue
              if [ "$DRY_RUN" = "true" ]; then
                echo "ğŸ” [DRY RUN] Would close issue #${ISSUE_NUM} (alert #${NUMBER} dismissed)"
              else
                gh issue comment "$ISSUE_NUM" \
                  --body "ğŸ”• CodeQL ê²½ë³´ê°€ ê¸°ê°(dismissed)ë˜ì–´ ì´ìŠˆë¥¼ ìë™ìœ¼ë¡œ ë‹«ìŠµë‹ˆë‹¤." \
                  --repo "${{ github.repository }}"
                gh issue close "$ISSUE_NUM" --repo "${{ github.repository }}"
                echo "âœ… Closed issue #${ISSUE_NUM} (alert #${NUMBER} dismissed)"
              fi
            done <<< "$OPEN_ISSUES"
          done
