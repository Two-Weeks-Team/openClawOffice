name: CodeQL Alert â†’ Issue

on:
  code_scanning_alert:
    types: [appeared_in_branch, reopened, reopened_by_user, fixed, closed_by_user]
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (ë¯¸ë¦¬ë³´ê¸°ë§Œ, ì‹¤ì œ ì´ìŠˆ ìƒì„± ì•ˆ í•¨)'
        type: boolean
        default: false

permissions:
  issues: write
  security-events: read

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1: ìƒˆ ê²½ë³´ ê°ì§€ â†’ ì´ìŠˆ ìƒì„±
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  create-issue:
    name: Create Issue for Alert
    if: >-
      github.event_name == 'code_scanning_alert' &&
      (github.event.action == 'appeared_in_branch' ||
       github.event.action == 'reopened' ||
       github.event.action == 'reopened_by_user')
    runs-on: ubuntu-latest
    steps:
      - name: Setup labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh label create "security"                --color "e4e669" --description "Security vulnerability"     --force --repo ${{ github.repository }} 2>/dev/null || true
          gh label create "codeql"                  --color "0075ca" --description "Detected by CodeQL"         --force --repo ${{ github.repository }} 2>/dev/null || true
          gh label create "codeql-alert-${{ github.event.alert.number }}" \
                                                    --color "d93f0b" --description "CodeQL alert #${{ github.event.alert.number }}" \
                                                    --force --repo ${{ github.repository }} 2>/dev/null || true

      - name: Check for duplicate
        id: dedup
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COUNT=$(gh issue list \
            --repo "${{ github.repository }}" \
            --label "codeql-alert-${{ github.event.alert.number }}" \
            --state all \
            --json number \
            --jq 'length')
          echo "count=${COUNT}" >> "$GITHUB_OUTPUT"

      - name: Create issue
        if: steps.dedup.outputs.count == '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ALERT_NUMBER: ${{ github.event.alert.number }}
          RULE_ID:      ${{ github.event.alert.rule.id }}
          RULE_DESC:    ${{ github.event.alert.rule.description }}
          SEC_SEV:      ${{ github.event.alert.rule.security_severity_level }}
          SEV:          ${{ github.event.alert.rule.severity }}
          FILE_PATH:    ${{ github.event.alert.most_recent_instance.location.path }}
          START_LINE:   ${{ github.event.alert.most_recent_instance.location.start_line }}
          MESSAGE:      ${{ github.event.alert.most_recent_instance.message.text }}
          ALERT_URL:    ${{ github.event.alert.html_url }}
        run: |
          SEVERITY="${SEC_SEV:-$SEV}"
          case "$SEVERITY" in
            critical) EMOJI="ğŸ”´" ;;
            high)     EMOJI="ğŸŸ " ;;
            medium)   EMOJI="ğŸŸ¡" ;;
            low)      EMOJI="ğŸŸ¢" ;;
            *)        EMOJI="âš ï¸"  ;;
          esac

          cat > /tmp/issue_body.md << EOF
          ## ${EMOJI} CodeQL ë³´ì•ˆ ê²½ë³´ \`#${ALERT_NUMBER}\`

          | í•­ëª© | ë‚´ìš© |
          |------|------|
          | **ê·œì¹™** | \`${RULE_ID}\` |
          | **ì„¤ëª…** | ${RULE_DESC} |
          | **ì‹¬ê°ë„** | ${SEVERITY} |
          | **ìœ„ì¹˜** | \`${FILE_PATH}:${START_LINE}\` |

          **ë©”ì‹œì§€**:
          > ${MESSAGE}

          ğŸ”— [CodeQL ê²½ë³´ ë³´ê¸°](${ALERT_URL})

          ---
          *ì´ ì´ìŠˆëŠ” CodeQL ë³´ì•ˆ ë¶„ì„ì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*
          EOF

          gh issue create \
            --repo "${{ github.repository }}" \
            --title "${EMOJI} [CodeQL #${ALERT_NUMBER}] ${RULE_DESC}" \
            --body-file /tmp/issue_body.md \
            --label "security,codeql,codeql-alert-${ALERT_NUMBER}"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2: ê²½ë³´ ìˆ˜ì •/ê¸°ê° â†’ ì—°ê²° ì´ìŠˆ ë‹«ê¸°
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  close-issue:
    name: Close Issue when Alert Resolved
    if: >-
      github.event_name == 'code_scanning_alert' &&
      (github.event.action == 'fixed' ||
       github.event.action == 'closed_by_user')
    runs-on: ubuntu-latest
    steps:
      - name: Close related issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUES=$(gh issue list \
            --repo "${{ github.repository }}" \
            --label "codeql-alert-${{ github.event.alert.number }}" \
            --state open \
            --json number \
            --jq '.[].number')

          if [ -z "$ISSUES" ]; then
            echo "No open issues found for alert #${{ github.event.alert.number }}"
            exit 0
          fi

          ACTION="${{ github.event.action }}"
          if [ "$ACTION" = "fixed" ]; then
            COMMENT="âœ… CodeQL ê²½ë³´ê°€ ì½”ë“œ ìˆ˜ì •ìœ¼ë¡œ í•´ê²°ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ìŠˆë¥¼ ìë™ìœ¼ë¡œ ë‹«ìŠµë‹ˆë‹¤."
          else
            COMMENT="ğŸ”• CodeQL ê²½ë³´ê°€ ê¸°ê°(dismissed)ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ìŠˆë¥¼ ìë™ìœ¼ë¡œ ë‹«ìŠµë‹ˆë‹¤."
          fi

          while IFS= read -r ISSUE_NUM; do
            [ -z "$ISSUE_NUM" ] && continue
            gh issue comment "$ISSUE_NUM" --body "$COMMENT" --repo "${{ github.repository }}"
            gh issue close "$ISSUE_NUM" --repo "${{ github.repository }}"
            echo "âœ… Closed issue #${ISSUE_NUM}"
          done <<< "$ISSUES"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 3: ê¸°ì¡´ ê²½ë³´ ì¼ê´„ ë™ê¸°í™” (ìˆ˜ë™ ì‹¤í–‰)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  sync-existing:
    name: Sync Existing Alerts â†’ Issues
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Setup base labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh label create "security" --color "e4e669" --description "Security vulnerability" --force --repo ${{ github.repository }} 2>/dev/null || true
          gh label create "codeql"   --color "0075ca" --description "Detected by CodeQL"     --force --repo ${{ github.repository }} 2>/dev/null || true

      - name: Sync all open alerts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          gh api "repos/${{ github.repository }}/code-scanning/alerts?state=open&per_page=100" \
            --paginate | jq -c '.[]' | while IFS= read -r alert; do

            NUMBER=$(echo "$alert"   | jq -r '.number')
            RULE_ID=$(echo "$alert"  | jq -r '.rule.id')
            RULE_DESC=$(echo "$alert"| jq -r '.rule.description')
            SEC_SEV=$(echo "$alert"  | jq -r '.rule.security_severity_level // empty')
            SEV=$(echo "$alert"      | jq -r '.rule.severity')
            SEVERITY="${SEC_SEV:-$SEV}"
            FILE_PATH=$(echo "$alert"| jq -r '.most_recent_instance.location.path')
            LINE=$(echo "$alert"     | jq -r '.most_recent_instance.location.start_line')
            MESSAGE=$(echo "$alert"  | jq -r '.most_recent_instance.message.text')
            HTML_URL=$(echo "$alert" | jq -r '.html_url')

            # ê²½ë³´ë³„ ë¼ë²¨ ìƒì„± (ì¤‘ë³µ ë°©ì§€ìš©)
            gh label create "codeql-alert-${NUMBER}" \
              --color "d93f0b" \
              --description "CodeQL alert #${NUMBER}" \
              --force \
              --repo "${{ github.repository }}" 2>/dev/null || true

            # ì¤‘ë³µ ì´ìŠˆ í™•ì¸
            COUNT=$(gh issue list \
              --repo "${{ github.repository }}" \
              --label "codeql-alert-${NUMBER}" \
              --state all \
              --json number \
              --jq 'length')

            if [ "$COUNT" -gt 0 ]; then
              echo "â­ï¸  Alert #${NUMBER} â€” ì´ìŠˆ ì´ë¯¸ ì¡´ì¬, ê±´ë„ˆëœ€"
              continue
            fi

            case "$SEVERITY" in
              critical) EMOJI="ğŸ”´" ;;
              high)     EMOJI="ğŸŸ " ;;
              medium)   EMOJI="ğŸŸ¡" ;;
              low)      EMOJI="ğŸŸ¢" ;;
              *)        EMOJI="âš ï¸"  ;;
            esac

            TITLE="${EMOJI} [CodeQL #${NUMBER}] ${RULE_DESC}"

            cat > "/tmp/issue_body_${NUMBER}.md" << EOF
          ## ${EMOJI} CodeQL ë³´ì•ˆ ê²½ë³´ \`#${NUMBER}\`

          | í•­ëª© | ë‚´ìš© |
          |------|------|
          | **ê·œì¹™** | \`${RULE_ID}\` |
          | **ì„¤ëª…** | ${RULE_DESC} |
          | **ì‹¬ê°ë„** | ${SEVERITY} |
          | **ìœ„ì¹˜** | \`${FILE_PATH}:${LINE}\` |

          **ë©”ì‹œì§€**:
          > ${MESSAGE}

          ğŸ”— [CodeQL ê²½ë³´ ë³´ê¸°](${HTML_URL})

          ---
          *ì´ ì´ìŠˆëŠ” CodeQL ë³´ì•ˆ ë¶„ì„ì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*
          EOF

            if [ "$DRY_RUN" = "true" ]; then
              echo "ğŸ” [DRY RUN] ìƒì„± ì˜ˆì •: ${TITLE}"
            else
              ISSUE_URL=$(gh issue create \
                --repo "${{ github.repository }}" \
                --title "$TITLE" \
                --body-file "/tmp/issue_body_${NUMBER}.md" \
                --label "security,codeql,codeql-alert-${NUMBER}")
              echo "âœ… Alert #${NUMBER} â†’ ${ISSUE_URL}"
            fi
          done
